{"version":3,"file":"index.js","sources":["../src/extract-critical.js","../src/inline.js","../src/stream.js","../src/index.js"],"sourcesContent":["// @flow\nimport type { Emotion } from 'create-emotion'\n\nconst createExtractCritical = (emotion: Emotion) => (html: string) => {\n  // parse out ids from html\n  // reconstruct css/rules/cache to pass\n  let RGX = new RegExp(`${emotion.caches.key}-([a-zA-Z0-9-]+)`, 'gm')\n\n  let o = { html, ids: [], css: '' }\n  let match\n  let ids = {}\n  while ((match = RGX.exec(html)) !== null) {\n    // $FlowFixMe\n    if (ids[match[1]] === undefined) {\n      // $FlowFixMe\n      ids[match[1]] = true\n    }\n  }\n\n  o.ids = Object.keys(emotion.caches.inserted).filter(id => {\n    if (\n      (ids[id] === true ||\n        emotion.caches.registered[`${emotion.caches.key}-${id}`] ===\n          undefined) &&\n      emotion.caches.inserted[id] !== true\n    ) {\n      o.css += emotion.caches.inserted[id]\n      return true\n    }\n  })\n\n  return o\n}\n\nexport default createExtractCritical\n","// @flow\nimport type { Emotion } from 'create-emotion'\n\nfunction generateStyleTag(\n  cssKey: string,\n  ids: string,\n  styles: string,\n  nonceString: string\n) {\n  return `<style data-emotion-${cssKey}=\"${ids.substring(\n    1\n  )}\"${nonceString}>${styles}</style>`\n}\n\nconst createRenderStylesToString = (emotion: Emotion, nonceString: string) => (\n  html: string\n): string => {\n  const { inserted, key: cssKey, registered } = emotion.caches\n  const regex = new RegExp(`<|${cssKey}-([a-zA-Z0-9-]+)`, 'gm')\n\n  const seen = {}\n\n  let result = ''\n  let globalIds = ''\n  let globalStyles = ''\n\n  for (const id in inserted) {\n    if (inserted.hasOwnProperty(id)) {\n      const style = inserted[id]\n      const key = `${cssKey}-${id}`\n      if (style !== true && registered[key] === undefined) {\n        globalStyles += style\n        globalIds += ` ${id}`\n      }\n    }\n  }\n\n  if (globalStyles !== '') {\n    result = generateStyleTag(cssKey, globalIds, globalStyles, nonceString)\n  }\n\n  let ids = ''\n  let styles = ''\n  let lastInsertionPoint = 0\n  let match\n\n  while ((match = regex.exec(html)) !== null) {\n    // $FlowFixMe\n    if (match[0] === '<') {\n      if (ids !== '') {\n        result += generateStyleTag(cssKey, ids, styles, nonceString)\n        ids = ''\n        styles = ''\n      }\n      // $FlowFixMe\n      result += html.substring(lastInsertionPoint, match.index)\n      // $FlowFixMe\n      lastInsertionPoint = match.index\n      continue\n    }\n    // $FlowFixMe\n    const id = match[1]\n    const style = inserted[id]\n    if (style === true || seen[id]) {\n      continue\n    }\n\n    seen[id] = true\n    styles += style\n    ids += ` ${id}`\n  }\n\n  result += html.substring(lastInsertionPoint)\n\n  return result\n}\n\nexport default createRenderStylesToString\n","// @flow\nimport type { Emotion } from 'create-emotion'\nimport through from 'through'\nimport tokenize from 'html-tokenize'\nimport pipe from 'multipipe'\n\nconst createRenderStylesToNodeStream = (\n  emotion: Emotion,\n  nonceString: string\n) => () => {\n  let insed = {}\n  const tokenStream = tokenize()\n\n  const inlineStream = through(\n    function write(thing) {\n      let [type, data] = thing\n      if (type === 'open') {\n        let css = ''\n        let ids = {}\n\n        let match\n        let fragment = data.toString()\n        let regex = new RegExp(`${emotion.caches.key}-([a-zA-Z0-9-]+)`, 'gm')\n        while ((match = regex.exec(fragment)) !== null) {\n          if (match !== null && insed[match[1]] === undefined) {\n            ids[match[1]] = true\n          }\n        }\n        Object.keys(emotion.caches.inserted).forEach(id => {\n          if (\n            emotion.caches.inserted[id] !== true &&\n            insed[id] === undefined &&\n            (ids[id] === true ||\n              (emotion.caches.registered[`${emotion.caches.key}-${id}`] ===\n                undefined &&\n                (ids[id] = true)))\n          ) {\n            insed[id] = true\n            // $FlowFixMe flow thinks emotion.caches.inserted[id] can be true even though it's checked earlier\n            css += emotion.caches.inserted[id]\n          }\n        })\n\n        if (css !== '') {\n          this.queue(\n            `<style data-emotion-${emotion.caches.key}=\"${Object.keys(ids).join(\n              ' '\n            )}\"${nonceString}>${css}</style>`\n          )\n        }\n      }\n      this.queue(data)\n    },\n    function end() {\n      this.queue(null)\n    }\n  )\n\n  return pipe(tokenStream, inlineStream)\n}\n\nexport default createRenderStylesToNodeStream\n","// @flow\nimport type { Emotion } from 'create-emotion'\nimport createExtractCritical from './extract-critical'\nimport createRenderStylesToString from './inline'\nimport createRenderStylesToStream from './stream'\n\nexport default function(emotion: Emotion) {\n  const nonceString =\n    emotion.caches.nonce !== undefined ? ` nonce=\"${emotion.caches.nonce}\"` : ''\n  return {\n    extractCritical: createExtractCritical(emotion),\n    renderStylesToString: createRenderStylesToString(emotion, nonceString),\n    renderStylesToNodeStream: createRenderStylesToStream(emotion, nonceString)\n  }\n}\n"],"names":["createExtractCritical","emotion","html","RGX","RegExp","caches","key","o","match","ids","exec","undefined","Object","keys","inserted","filter","id","registered","css","generateStyleTag","cssKey","styles","nonceString","substring","createRenderStylesToString","regex","seen","result","globalIds","globalStyles","hasOwnProperty","style","lastInsertionPoint","index","createRenderStylesToNodeStream","insed","tokenStream","tokenize","inlineStream","through","write","thing","type","data","fragment","toString","forEach","queue","join","end","pipe","nonce","createRenderStylesToStream"],"mappings":"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"}